# Python微服务设计与DevOps实践
本项目从轻量级云边端协同的拟开发基于云边端协同的控制系统。基于Python语言，使用Sanic搭建web框架和服务器，由Mysql数据库完成数据持久化存储，结合SSH和SSL/TLS的web安全传输协议，构建了基于客户端、中心云、边缘云、边端设备间的云边端设备信息控制管理系统，重点实现了边端设备与边缘云消息的异步心跳上传以及中心云和边缘云对持久化存储信息的实时同步，并聚焦于开发出一套可复用的程序模块。基本系统架构设计可以归纳为以中心云服务器为中心，下辖多个边端云服务器和客户端，而每个边端云服务器又可继续下辖管理多个边端设备的结构。这样的设计将中心云服务器的大部分南向服务任务转移给了各个边端云服务器，而中心云服务器只需要负责对小部分的边缘云服务器进行管理即可，从极大的程度上减轻了中心云服务器的数据处理压力。
![image](https://github.com/user-attachments/assets/ebd65767-f251-415b-931b-c8d6c3bcec26)
对于每个服务器，都有配套的Mysql持久化存储设计，由于中心云服务器与边缘云服务器在设计构想上异地，故在设计上为每一个服务器结构构建了一个单独的mysql database，而每个服务器下的不同功能则分别采用当地mysql数据库中的不同table进行储存和管理。
![image](https://github.com/user-attachments/assets/e558091d-247f-4a4c-a442-74f0dfddd9e4)

# 北向
北向功能主要分为中心云服务器面向客户端的用户登录和设备注册服务，和客户端面向边端设备和边缘云服务器的消息下发及中心云服务器的日志获取服务。有关北向服务的设备注册服务的具体实现展示如下，主要实现了对于单体边端设备的增删改查操作，对设备分组的增删改查操作，以及基于设备分组而作用于边端设备单体的增删查改相关操作。其中基于分组的操作通过将不同的客户端用户映射至不同的组别，极大地方便了对于用户鉴权和用户权限管理的设计。
![image](https://github.com/user-attachments/assets/831b068b-f006-4e60-a9ca-5070eff68dd3)

# 南向
南向的控制器登录边缘云服务器或边缘云服务器登录中心云服务器时，为确保安全，会使用提前获得的token附在报文中，在登录时权限被接收到请求的边缘云服务器或中心云服务器在本地检查，若验证成功则返回一个结果，从而建立连接，若验证失败则不返回，通过连接超时来中断连接；在实际项目中，边端云与设备均有使用此逻辑。边缘服务器登陆后，建立起边缘云到中心云的websocket连接，并在同时开启边缘数据库的同步检测，对称的检测操作也同时发起在中心云服务器上。包含身份验证和登录同步，登陆后建立起设备到边缘云的websocket连接，相关的数据库同步操作在连接建立后也被启用，在每次增删改及相关在任何一边被执行时触发，用以保证中心云服务器与边缘云服务器的数据完全一致。相关操作将中心云服务器与边缘云服务器作为中转，最终作用于控制器，通信在已建立的websocket连接上进行，该交互在默认多方均已经完成了登录的情况下执行。
![image](https://github.com/user-attachments/assets/0bbb901f-8ec8-483c-b5ad-cdb278df2702)

# 客户端接口单元测试
使用linux shell脚本批量模仿客户端向中心云服务器发送消息，在终端执行后每隔2秒执行一条，方便逐个检查各北向接口。其中，接收到的来自中心云服务器的返回消息可在shell脚本执行终端窗口查看，中心云服务器打印的对应消息可在中心云服务器运行终端窗口查看。进行该项测试的好处在于通过基本的中心云服务器单元测试，可以在系统测试之前，把大部分比较低级的错误都消灭掉，减少系统测试过程中的问题，这样也就在系统测试中将错误定位范围排除至中心云服务器之外，从而减少了系统测试中定位和解决问题的时间成本；此外，通过执行中心云服务器的单元测试还可以在单元层面对各个细节方面的问题及潜在问题进行排查，这将包含到一些在系统测试中无法涉及或直观体现的步骤（如边端设备与中心云服务器直接通信报文错误，从报文中获取的变量数据类型错误等）；最后，在单元测试中shell脚本避免了频繁使用命令行输入指令。由于编写的脚本在合理的测试顺序涉及下将可以遍历到所有输入且具有一定的泛用性，为开发节约了频繁调试试时的时间成本。在本次的项目设计过程中，测试方案如下：
![image](https://github.com/user-attachments/assets/a8fcf93d-08cb-49d7-9a79-5fcd6a371a68)
该测试方案的好处在于其可以以最短的路径遍历北向所有接口及其涉及的功能，而恢复所有数据库数据至初始状态只需要执行沿虚线路径的三步操作，可以集成于另一脚本，且耗时较少。具体的测试脚本在项目devops_edge_beta8中命名为test.sh，而恢复脚本为test_1.sh。脚本内容以发送curl指令为主，其间有sleep指令实现暂停，方便展示。以下为来自test.sh的ADD接口测试部分：
![image](https://github.com/user-attachments/assets/cb97f915-3e6c-41a2-a56b-59caf6943311)
